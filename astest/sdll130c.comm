# coding=utf-8
# --------------------------------------------------------------------
# Copyright (C) 1991 - 2025 - EDF R&D - www.code-aster.org
# This file is part of code_aster.
#
# code_aster is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# code_aster is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with code_aster.  If not, see <http://www.gnu.org/licenses/>.
# --------------------------------------------------------------------

#        ELEMENT POU_D_E COMPORTEMENT LINEAIRE
#
DEBUT(CODE="OUI", DEBUG=_F(SDVERI="NON"))
# SDVERI='NON' car la verification est trop couteuse en CPU
# TEST EN NON_REGRESSION SERVANT DE REFERENCE A SDLL130B

# LECTURE DU SEISME
from sdll130a import F_ACS2C11

ACS2C11 = F_ACS2C11()

# LECTURE MAILLAGE LINEIQUE
MAPOU = LIRE_MAILLAGE(FORMAT="MED", UNITE=19)
MAPOU = DEFI_GROUP(
    reuse=MAPOU, MAILLAGE=MAPOU, CREA_GROUP_NO=_F(GROUP_MA="POUTRE", NOM="TOUS_NO"), INFO=1
)

MOPOU = AFFE_MODELE(
    MAILLAGE=MAPOU, AFFE=_F(TOUT="OUI", PHENOMENE="MECANIQUE", MODELISATION="POU_D_E")
)
# LES MATERIAUX
#


BETON = DEFI_MATERIAU(
    ELAS=_F(
        E=3.7272000000e10,
        NU=0.0,
        RHO=2400.0,
        AMOR_ALPHA=8.5000000000000006e-05,
        AMOR_BETA=18.984999999999999,
    )
)
#
# LES CHAMPS DE MATERIAUX
#


CHMAT = AFFE_MATERIAU(MAILLAGE=MAPOU, AFFE=_F(GROUP_MA="POUTRE", MATER=BETON))
#
# ORIENTATIONS ET RIGIDITE DE TORSION
#


POUCA = AFFE_CARA_ELEM(
    MODELE=MOPOU,
    POUTRE=_F(
        GROUP_MA=("POUTRE"),
        SECTION="GENERALE",
        CARA=("A", "IY", "IZ", "JX"),
        VALE=(0.109, 0.0025138000000000001, 0.00025000000000000001, 1.0),
    ),
    ORIENTATION=_F(GROUP_MA=("POUTRE"), CARA="ANGL_VRIL", VALE=-90.0),
)
#
#


BLOCAGE = AFFE_CHAR_MECA(
    MODELE=MOPOU,
    DDL_IMPO=(
        _F(GROUP_NO="A", DX=0.0, DY=0.0),
        _F(GROUP_NO="B", DY=1.0),
        _F(GROUP_NO="TOUS_NO", DZ=0.0, DRX=0.0, DRY=0.0),
    ),
)
#
#


RIGI_ELE = CALC_MATR_ELEM(
    OPTION="RIGI_MECA", MODELE=MOPOU, CHAM_MATER=CHMAT, CARA_ELEM=POUCA, CHARGE=BLOCAGE
)

MASS_ELE = CALC_MATR_ELEM(
    OPTION="MASS_MECA", MODELE=MOPOU, CHAM_MATER=CHMAT, CARA_ELEM=POUCA, CHARGE=BLOCAGE
)

AMOR_ELE = CALC_MATR_ELEM(
    OPTION="AMOR_MECA",
    MODELE=MOPOU,
    CARA_ELEM=POUCA,
    CHAM_MATER=CHMAT,
    RIGI_MECA=RIGI_ELE,
    MASS_MECA=MASS_ELE,
    CHARGE=BLOCAGE,
)
#
#


NUMEDDL = NUME_DDL(MATR_RIGI=RIGI_ELE)
#
VELEM = CALC_VECT_ELEM(CARA_ELEM=POUCA, CHARGE=BLOCAGE, OPTION="CHAR_MECA")

VECBLO = ASSE_VECTEUR(INFO=1, NUME_DDL=NUMEDDL, VECT_ELEM=VELEM)

RIGIDITE = ASSE_MATRICE(MATR_ELEM=RIGI_ELE, NUME_DDL=NUMEDDL)

MASSE = ASSE_MATRICE(MATR_ELEM=MASS_ELE, NUME_DDL=NUMEDDL)

AMORT = ASSE_MATRICE(MATR_ELEM=AMOR_ELE, NUME_DDL=NUMEDDL)


#
# ON DEFINIT L'ACCELEROGRAMME DU SEISME
#


ACCELERO = CALC_FONCTION(COMB=_F(FONCTION=ACS2C11, COEF=137.0))
#
#


DIRSEISM = CALC_CHAR_SEISME(MATR_MASS=MASSE, DIRECTION=(0.0, -1.0, 0.0), MONO_APPUI="OUI")
# CALCUL DYNAMIQUE LINEAIRE TRANSITOIRE
#


LINST = DEFI_LIST_REEL(DEBUT=0.0, INTERVALLE=_F(JUSQU_A=5.0, NOMBRE=500))

U1 = DYNA_VIBRA(
    MODELE=MOPOU,
    CARA_ELEM=POUCA,
    CHAM_MATER=CHMAT,
    TYPE_CALCUL="TRAN",
    BASE_CALCUL="PHYS",
    MATR_MASS=MASSE,
    MATR_RIGI=RIGIDITE,
    MATR_AMOR=AMORT,
    SCHEMA_TEMPS=_F(SCHEMA="NEWMARK"),
    EXCIT=(_F(VECT_ASSE=DIRSEISM, FONC_MULT=ACCELERO), _F(VECT_ASSE=VECBLO)),
    INCREMENT=_F(LIST_INST=LINST),
)

U1 = CALC_CHAMP(reuse=U1, TOUT="OUI", TOUT_ORDRE="OUI", CONTRAINTE=("SIEF_ELGA"), RESULTAT=U1)

TEST_RESU(
    RESU=(
        _F(NUME_ORDRE=100, GROUP_NO="B", RESULTAT=U1, NOM_CHAM="DEPL", NOM_CMP="DY", VALE_CALC=1.0),
        _F(
            NUME_ORDRE=100,
            GROUP_NO="C",
            RESULTAT=U1,
            NOM_CHAM="DEPL",
            NOM_CMP="DY",
            VALE_CALC=0.5035278033969633,
        ),
        _F(NUME_ORDRE=200, GROUP_NO="B", RESULTAT=U1, NOM_CHAM="DEPL", NOM_CMP="DY", VALE_CALC=1.0),
        _F(
            NUME_ORDRE=200,
            GROUP_NO="C",
            RESULTAT=U1,
            NOM_CHAM="DEPL",
            NOM_CMP="DY",
            VALE_CALC=0.4979636434401749,
        ),
        _F(NUME_ORDRE=268, GROUP_NO="B", RESULTAT=U1, NOM_CHAM="DEPL", NOM_CMP="DY", VALE_CALC=1.0),
        _F(
            NUME_ORDRE=268,
            GROUP_NO="C",
            RESULTAT=U1,
            NOM_CHAM="DEPL",
            NOM_CMP="DY",
            VALE_CALC=0.5085478989019429,
        ),
        _F(NUME_ORDRE=468, GROUP_NO="B", RESULTAT=U1, NOM_CHAM="DEPL", NOM_CMP="DY", VALE_CALC=1.0),
        _F(
            NUME_ORDRE=468,
            GROUP_NO="C",
            RESULTAT=U1,
            NOM_CHAM="DEPL",
            NOM_CMP="DY",
            VALE_CALC=0.4908926900742185,
        ),
    )
)


# CALCUL AVEC AFFE_CHAR_MECA_F et FONC_MULT non constante pour référence

ZERO = DEFI_CONSTANTE(VALE=0.0)
V_INST = FORMULE(VALE="(1+INST)**2", NOM_PARA="INST")

BLOCAGE = AFFE_CHAR_MECA_F(
    MODELE=MOPOU,
    DDL_IMPO=(
        _F(GROUP_NO="A", DX=ZERO, DY=ZERO),
        _F(GROUP_NO="B", DY=V_INST),
        _F(GROUP_NO="TOUS_NO", DZ=ZERO, DRX=ZERO, DRY=ZERO),
    ),
)
#
#

FF = FORMULE(VALE="1./(1+INST)", NOM_PARA="INST")


RIGI_ELE = CALC_MATR_ELEM(
    OPTION="RIGI_MECA", MODELE=MOPOU, CHAM_MATER=CHMAT, CARA_ELEM=POUCA, CHARGE=BLOCAGE
)

MASS_ELE = CALC_MATR_ELEM(
    OPTION="MASS_MECA", MODELE=MOPOU, CHAM_MATER=CHMAT, CARA_ELEM=POUCA, CHARGE=BLOCAGE
)

AMOR_ELE = CALC_MATR_ELEM(
    OPTION="AMOR_MECA",
    MODELE=MOPOU,
    CARA_ELEM=POUCA,
    CHAM_MATER=CHMAT,
    RIGI_MECA=RIGI_ELE,
    MASS_MECA=MASS_ELE,
    CHARGE=BLOCAGE,
)
#
#


NUMEDDL = NUME_DDL(MATR_RIGI=RIGI_ELE)

RIGIDITE = ASSE_MATRICE(MATR_ELEM=RIGI_ELE, NUME_DDL=NUMEDDL)

MASSE = ASSE_MATRICE(MATR_ELEM=MASS_ELE, NUME_DDL=NUMEDDL)

AMORT = ASSE_MATRICE(MATR_ELEM=AMOR_ELE, NUME_DDL=NUMEDDL)


DIRSEISM = CALC_CHAR_SEISME(MATR_MASS=MASSE, DIRECTION=(0.0, -1.0, 0.0), MONO_APPUI="OUI")
# CALCUL DYNAMIQUE LINEAIRE TRANSITOIRE
#


U1F = DYNA_VIBRA(
    MODELE=MOPOU,
    CARA_ELEM=POUCA,
    CHAM_MATER=CHMAT,
    TYPE_CALCUL="TRAN",
    BASE_CALCUL="PHYS",
    MATR_MASS=MASSE,
    MATR_RIGI=RIGIDITE,
    MATR_AMOR=AMORT,
    SCHEMA_TEMPS=_F(SCHEMA="NEWMARK"),
    EXCIT=(_F(VECT_ASSE=DIRSEISM, FONC_MULT=ACCELERO), _F(CHARGE=BLOCAGE, FONC_MULT=FF)),
    INCREMENT=_F(LIST_INST=LINST, INST_FIN=3),
)

TEST_RESU(
    RESU=(
        _F(
            INST=1,
            GROUP_NO="B",
            REFERENCE="ANALYTIQUE",
            RESULTAT=U1F,
            NOM_CHAM="DEPL",
            NOM_CMP="DY",
            VALE_CALC=2.0,
            VALE_REFE=2,
        ),
        _F(
            INST=1,
            GROUP_NO="C",
            RESULTAT=U1F,
            NOM_CHAM="DEPL",
            NOM_CMP="DY",
            VALE_CALC=1.00333035144289,
        ),
        _F(
            INST=2,
            GROUP_NO="B",
            REFERENCE="ANALYTIQUE",
            RESULTAT=U1F,
            NOM_CHAM="DEPL",
            NOM_CMP="DY",
            VALE_CALC=3.0,
            VALE_REFE=3,
        ),
        _F(
            INST=2,
            GROUP_NO="C",
            RESULTAT=U1F,
            NOM_CHAM="DEPL",
            NOM_CMP="DY",
            VALE_CALC=1.497749216143394,
        ),
        _F(
            INST=3,
            GROUP_NO="B",
            REFERENCE="ANALYTIQUE",
            RESULTAT=U1F,
            NOM_CHAM="DEPL",
            NOM_CMP="DY",
            VALE_CALC=4.0,
            VALE_REFE=4,
        ),
        _F(
            INST=3,
            GROUP_NO="C",
            RESULTAT=U1F,
            NOM_CHAM="DEPL",
            NOM_CMP="DY",
            VALE_CALC=1.9982537684381767,
        ),
    )
)


FIN()
