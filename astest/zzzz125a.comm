# coding=utf-8
# --------------------------------------------------------------------
# Copyright (C) 1991 - 2025 - EDF R&D - www.code-aster.org
# This file is part of code_aster.
#
# code_aster is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# code_aster is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with code_aster.  If not, see <http://www.gnu.org/licenses/>.
# --------------------------------------------------------------------

DEBUT(CODE="OUI", ERREUR=_F(ALARME="EXCEPTION"), DEBUG=_F(SDVERI="OUI"))

mamec = LIRE_MAILLAGE()

# construction de la variable de commande TEMP à partir de la table
# ===

TABLE_TEMP = LIRE_TABLE(UNITE=30)
temp_values = TABLE_TEMP.EXTR_TABLE().values()
inst = temp_values["INST"]
temp = temp_values["TEMP"]

affe = []
for i, t in zip(inst, temp):
    champ = CREA_CHAMP(
        TYPE_CHAM="NOEU_TEMP_R",
        OPERATION="AFFE",
        MAILLAGE=mamec,
        AFFE=_F(TOUT="OUI", NOM_CMP="TEMP", VALE=t),
    )
    affe.append({"NOM_CHAM": "TEMP", "CHAM_GD": champ, "INST": i})

t_proj = CREA_RESU(OPERATION="AFFE", TYPE_RESU="EVOL_THER", AFFE=affe)

# construction d'un résultat mécanique bidon contenant les bon matériaux et la variable de commande TEMP
# ===

momec = AFFE_MODELE(
    MAILLAGE=mamec, AFFE=_F(GROUP_MA=("SMB"), PHENOMENE="MECANIQUE", MODELISATION="AXIS")
)

E_MB = DEFI_FONCTION(
    NOM_PARA="TEMP",
    VALE=(
        0.0,
        205000.0,
        20.0,
        204000.0,
        50.0,
        203000.0,
        100.0,
        200000.0,
        150.0,
        197000.0,
        200.0,
        193000.0,
        250.0,
        189000.0,
        300.0,
        185000.0,
        350.0,
        180000.0,
        400.0,
        176000.0,
        450.0,
        171000.0,
        500.0,
        166000.0,
        550.0,
        160000.0,
        600.0,
        155000.0,
    ),
)

NU_MB = DEFI_CONSTANTE(VALE=0.3)

K_IC = DEFI_FONCTION(
    NOM_PARA="TEMP",
    VALE=(
        0.00000e00,
        1088.889590046877,
        1.00000e00,
        1093.1633916274438,
        2.00000e00,
        1097.4924917910698,
        3.00000e00,
        1101.879032320053,
        4.00000e00,
        1106.3252379505618,
        5.00000e00,
        1110.8334195855368,
        6.00000e00,
        1115.4059776320403,
        7.00000e00,
        1120.0454054678594,
        8.00000e00,
        1124.7542930423763,
        9.00000e00,
        1129.5353306169063,
        1.00000e01,
        1134.3913126499021,
        1.10000e01,
        1139.3251418326374,
        1.20000e01,
        1144.3398332811978,
        1.30000e01,
        1149.4385188908318,
        1.40000e01,
        1154.6244518589526,
        1.50000e01,
        1159.9010113833199,
        1.60000e01,
        1165.2717075421886,
        1.70000e01,
        1170.7401863634718,
        1.80000e01,
        1176.3102350902388,
        1.90000e01,
        1181.9857876501528,
        2.00000e01,
        1187.7709303367449,
        2.10000e01,
        1193.6699077107326,
        2.20000e01,
        1199.6871287299025,
        2.30000e01,
        1205.8271731164134,
        2.40000e01,
        1212.0947979707082,
        2.50000e01,
        1218.4949446415958,
        2.60000e01,
        1225.0327458624158,
        2.70000e01,
        1231.7135331635984,
        2.80000e01,
        1238.5428445723205,
        2.90000e01,
        1245.5264326103797,
        3.00000e01,
        1252.670272601834,
        3.10000e01,
        1259.9805713024102,
        3.20000e01,
        1267.4637758631352,
        3.30000e01,
        1275.126583141145,
        3.40000e01,
        1282.9759493711083,
        3.50000e01,
        1291.0191002112385,
        3.60000e01,
        1299.2635411784006,
        3.70000e01,
        1307.7170684873806,
        3.80000e01,
        1316.3877803099754,
        3.90000e01,
        1325.284088470159,
        4.00000e01,
        1334.4147305922197,
        4.10000e01,
        1343.7887827194056,
        4.20000e01,
        1353.4156724213108,
        4.30000e01,
        1363.3051924089218,
        4.40000e01,
        1373.4675146769953,
        4.50000e01,
        1383.9132051941856,
        4.60000e01,
        1394.6532391621397,
        4.70000e01,
        1405.6990168655957,
        4.80000e01,
        1417.0623801363738,
        4.90000e01,
        1428.7556294550411,
        5.00000e01,
        1440.7915417149422,
        5.10000e01,
        1453.1833886742525,
        5.20000e01,
        1465.944956122704,
        5.30000e01,
        1479.090563790662,
        5.40000e01,
        1492.635086029303,
        5.50000e01,
        1506.5939732917627,
        5.60000e01,
        1520.983274446275,
        5.70000e01,
        1535.8196599535274,
        5.80000e01,
        1551.120445941702,
        5.90000e01,
        1566.9036192139747,
        6.00000e01,
        1583.187863224583,
        6.10000e01,
        1599.9925850609825,
        6.20000e01,
        1617.3379434710514,
        6.30000e01,
        1635.2448779758279,
        6.40000e01,
        1653.7351391098146,
        6.50000e01,
        1672.8313198325316,
        6.60000e01,
        1692.5568881566758,
        6.70000e01,
        1712.9362210400093,
        6.80000e01,
        1733.994639589921,
        6.90000e01,
        1755.758445631508,
        7.00000e01,
        1778.25495969198,
        7.10000e01,
        1801.5125604562488,
        7.20000e01,
        1825.560725750679,
        7.30000e01,
        1850.430075114194,
        7.40000e01,
        1876.15241401821,
        7.50000e01,
        1902.760779799263,
        7.60000e01,
        1930.289489370664,
        7.70000e01,
        1958.7741887820853,
        7.80000e01,
        1988.25190469865,
        7.90000e01,
        2018.7610978738712,
        8.00000e01,
        2050.3417186936626,
        8.10000e01,
        2083.035264871639,
        8.20000e01,
        2116.8848413790242,
        8.30000e01,
        2151.935222695721,
        8.40000e01,
        2188.2329174724414,
        8.50000e01,
        2225.826235697277,
        8.60000e01,
        2264.7653584637196,
        8.70000e01,
        2305.10241044088,
        8.80000e01,
        2346.8915351505652,
        8.90000e01,
        2390.1889731599354,
        9.00000e01,
        2435.053143302656,
        9.10000e01,
        2481.544727045839,
        9.20000e01,
        2529.726756124636,
        9.30000e01,
        2579.664703571008,
        9.40000e01,
        2631.4265782681655,
        9.50000e01,
        2685.083023167212,
        9.60000e01,
        2740.7074173078418,
        9.70000e01,
        2798.3759817904233,
        9.80000e01,
        2858.167889852514,
        9.90000e01,
        2920.165381208773,
        1.00000e02,
        2984.4538808194006,
        1.01000e02,
        3051.1221222586214,
        1.02000e02,
        3120.26227586139,
        1.03000e02,
        3191.970081833369,
        1.04000e02,
        3266.3449885164214,
        1.05000e02,
        3343.4902960092963,
        1.06000e02,
        3423.513305350926,
        1.07000e02,
        3506.5254734817727,
        1.08000e02,
        3592.6425742070087,
        1.09000e02,
        3681.984865394021,
        1.10000e02,
        3774.6772626456614,
        1.11000e02,
        3870.8495197000875,
        1.12000e02,
        3970.636415817705,
        1.13000e02,
        4074.177950425842,
        1.14000e02,
        4181.619545302249,
        1.15000e02,
        4293.112254589419,
        1.16000e02,
        4408.81298294301,
        1.17000e02,
        4528.88471212944,
        1.18000e02,
        4653.496736399881,
        1.19000e02,
        4782.824906980567,
        1.20000e02,
        4917.051886032529,
        1.21000e02,
        5056.367410447496,
        1.22000e02,
        5200.968565860934,
        1.23000e02,
        5351.060071277957,
        1.24000e02,
        5506.854574723136,
        1.25000e02,
        5668.572960341205,
        1.26000e02,
        5836.444667392149,
        1.27000e02,
        6010.70802160136,
        1.28000e02,
        6191.610579343402,
        1.29000e02,
        6379.409485156433,
        1.30000e02,
        6574.3718431036,
        1.31000e02,
        6776.775102517727,
        1.32000e02,
        6986.9074586863535,
        1.33000e02,
        7205.068269055823,
        1.34000e02,
        7431.568485555437,
        1.35000e02,
        7618.989667648264,
        1.36000e02,
        7618.989667648264,
        1.37000e02,
        7618.989667648264,
        1.38000e02,
        7618.989667648264,
        1.39000e02,
        7618.989667648264,
        1.40000e02,
        7618.989667648264,
        1.41000e02,
        7618.989667648264,
        1.42000e02,
        7618.989667648264,
        1.43000e02,
        7618.989667648264,
        1.44000e02,
        7618.989667648264,
        1.45000e02,
        7618.989667648264,
        1.46000e02,
        7618.989667648264,
        1.47000e02,
        7618.989667648264,
        1.48000e02,
        7618.989667648264,
        1.49000e02,
        7618.989667648264,
        1.50000e02,
        7618.989667648264,
        1.51000e02,
        7618.989667648264,
        1.52000e02,
        7618.989667648264,
        1.53000e02,
        7618.989667648264,
        1.54000e02,
        7618.989667648264,
        1.55000e02,
        7618.989667648264,
        1.56000e02,
        7618.989667648264,
        1.57000e02,
        7618.989667648264,
        1.58000e02,
        7618.989667648264,
        1.59000e02,
        7618.989667648264,
        1.60000e02,
        7618.989667648264,
        1.61000e02,
        7618.989667648264,
        1.62000e02,
        7618.989667648264,
        1.63000e02,
        7618.989667648264,
        1.64000e02,
        7618.989667648264,
        1.65000e02,
        7618.989667648264,
        1.66000e02,
        7618.989667648264,
        1.67000e02,
        7618.989667648264,
        1.68000e02,
        7618.989667648264,
        1.69000e02,
        7618.989667648264,
        1.70000e02,
        7618.989667648264,
        1.71000e02,
        7618.989667648264,
        1.72000e02,
        7618.989667648264,
        1.73000e02,
        7618.989667648264,
        1.74000e02,
        7618.989667648264,
        1.75000e02,
        7618.989667648264,
        1.76000e02,
        7618.989667648264,
        1.77000e02,
        7618.989667648264,
        1.78000e02,
        7618.989667648264,
        1.79000e02,
        7618.989667648264,
        1.80000e02,
        7618.989667648264,
        1.81000e02,
        7618.989667648264,
        1.82000e02,
        7618.989667648264,
        1.83000e02,
        7618.989667648264,
        1.84000e02,
        7618.989667648264,
        1.85000e02,
        7618.989667648264,
        1.86000e02,
        7618.989667648264,
        1.87000e02,
        7618.989667648264,
        1.88000e02,
        7618.989667648264,
        1.89000e02,
        7618.989667648264,
        1.90000e02,
        7618.989667648264,
        1.91000e02,
        7618.989667648264,
        1.92000e02,
        7618.989667648264,
        1.93000e02,
        7618.989667648264,
        1.94000e02,
        7618.989667648264,
        1.95000e02,
        7618.989667648264,
        1.96000e02,
        7618.989667648264,
        1.97000e02,
        7618.989667648264,
        1.98000e02,
        7618.989667648264,
        1.99000e02,
        7618.989667648264,
        2.00000e02,
        7618.989667648264,
        2.01000e02,
        7618.989667648264,
        2.02000e02,
        7618.989667648264,
        2.03000e02,
        7618.989667648264,
        2.04000e02,
        7618.989667648264,
        2.05000e02,
        7618.989667648264,
        2.06000e02,
        7618.989667648264,
        2.07000e02,
        7618.989667648264,
        2.08000e02,
        7618.989667648264,
        2.09000e02,
        7618.989667648264,
        2.10000e02,
        7618.989667648264,
        2.11000e02,
        7618.989667648264,
        2.12000e02,
        7618.989667648264,
        2.13000e02,
        7618.989667648264,
        2.14000e02,
        7618.989667648264,
        2.15000e02,
        7618.989667648264,
        2.16000e02,
        7618.989667648264,
        2.17000e02,
        7618.989667648264,
        2.18000e02,
        7618.989667648264,
        2.19000e02,
        7618.989667648264,
        2.20000e02,
        7618.989667648264,
        2.21000e02,
        7618.989667648264,
        2.22000e02,
        7618.989667648264,
        2.23000e02,
        7618.989667648264,
        2.24000e02,
        7618.989667648264,
        2.25000e02,
        7618.989667648264,
        2.26000e02,
        7618.989667648264,
        2.27000e02,
        7618.989667648264,
        2.28000e02,
        7618.989667648264,
        2.29000e02,
        7618.989667648264,
        2.30000e02,
        7618.989667648264,
        2.31000e02,
        7618.989667648264,
        2.32000e02,
        7618.989667648264,
        2.33000e02,
        7618.989667648264,
        2.34000e02,
        7618.989667648264,
        2.35000e02,
        7618.989667648264,
        2.36000e02,
        7618.989667648264,
        2.37000e02,
        7618.989667648264,
        2.38000e02,
        7618.989667648264,
        2.39000e02,
        7618.989667648264,
        2.40000e02,
        7618.989667648264,
        2.41000e02,
        7618.989667648264,
        2.42000e02,
        7618.989667648264,
        2.43000e02,
        7618.989667648264,
        2.44000e02,
        7618.989667648264,
        2.45000e02,
        7618.989667648264,
        2.46000e02,
        7618.989667648264,
        2.47000e02,
        7618.989667648264,
        2.48000e02,
        7618.989667648264,
        2.49000e02,
        7618.989667648264,
        2.50000e02,
        7618.989667648264,
        2.51000e02,
        7618.989667648264,
        2.52000e02,
        7618.989667648264,
        2.53000e02,
        7618.989667648264,
        2.54000e02,
        7618.989667648264,
        2.55000e02,
        7618.989667648264,
        2.56000e02,
        7618.989667648264,
        2.57000e02,
        7618.989667648264,
        2.58000e02,
        7618.989667648264,
        2.59000e02,
        7618.989667648264,
        2.60000e02,
        7618.989667648264,
        2.61000e02,
        7618.989667648264,
        2.62000e02,
        7618.989667648264,
        2.63000e02,
        7618.989667648264,
        2.64000e02,
        7618.989667648264,
        2.65000e02,
        7618.989667648264,
        2.66000e02,
        7618.989667648264,
        2.67000e02,
        7618.989667648264,
        2.68000e02,
        7618.989667648264,
        2.69000e02,
        7618.989667648264,
        2.70000e02,
        7618.989667648264,
        2.71000e02,
        7618.989667648264,
        2.72000e02,
        7618.989667648264,
        2.73000e02,
        7618.989667648264,
        2.74000e02,
        7618.989667648264,
        2.75000e02,
        7618.989667648264,
        2.76000e02,
        7618.989667648264,
        2.77000e02,
        7618.989667648264,
        2.78000e02,
        7618.989667648264,
        2.79000e02,
        7618.989667648264,
        2.80000e02,
        7618.989667648264,
        2.81000e02,
        7618.989667648264,
        2.82000e02,
        7618.989667648264,
        2.83000e02,
        7618.989667648264,
        2.84000e02,
        7618.989667648264,
        2.85000e02,
        7618.989667648264,
        2.86000e02,
        7618.989667648264,
        2.87000e02,
        7618.989667648264,
        2.88000e02,
        7618.989667648264,
        2.89000e02,
        7618.989667648264,
        2.90000e02,
        7618.989667648264,
        2.91000e02,
        7618.989667648264,
        2.92000e02,
        7618.989667648264,
        2.93000e02,
        7618.989667648264,
        2.94000e02,
        7618.989667648264,
        2.95000e02,
        7618.989667648264,
        2.96000e02,
        7618.989667648264,
        2.97000e02,
        7618.989667648264,
        2.98000e02,
        7618.989667648264,
        2.99000e02,
        7618.989667648264,
        3.00000e02,
        7618.989667648264,
        3.01000e02,
        7618.989667648264,
        3.02000e02,
        7618.989667648264,
        3.03000e02,
        7618.989667648264,
        3.04000e02,
        7618.989667648264,
        3.05000e02,
        7618.989667648264,
        3.06000e02,
        7618.989667648264,
        3.07000e02,
        7618.989667648264,
        3.08000e02,
        7618.989667648264,
        3.09000e02,
        7618.989667648264,
        3.10000e02,
        7618.989667648264,
        3.11000e02,
        7618.989667648264,
        3.12000e02,
        7618.989667648264,
        3.13000e02,
        7618.989667648264,
        3.14000e02,
        7618.989667648264,
        3.15000e02,
        7618.989667648264,
        3.16000e02,
        7618.989667648264,
        3.17000e02,
        7618.989667648264,
        3.18000e02,
        7618.989667648264,
        3.19000e02,
        7618.989667648264,
        3.20000e02,
        7618.989667648264,
        3.21000e02,
        7618.989667648264,
        3.22000e02,
        7618.989667648264,
        3.23000e02,
        7618.989667648264,
        3.24000e02,
        7618.989667648264,
        3.25000e02,
        7618.989667648264,
        3.26000e02,
        7618.989667648264,
        3.27000e02,
        7618.989667648264,
        3.28000e02,
        7618.989667648264,
        3.29000e02,
        7618.989667648264,
        3.30000e02,
        7618.989667648264,
        3.31000e02,
        7618.989667648264,
        3.32000e02,
        7618.989667648264,
        3.33000e02,
        7618.989667648264,
        3.34000e02,
        7618.989667648264,
        3.35000e02,
        7618.989667648264,
        3.36000e02,
        7618.989667648264,
        3.37000e02,
        7618.989667648264,
        3.38000e02,
        7618.989667648264,
        3.39000e02,
        7618.989667648264,
        3.40000e02,
        7618.989667648264,
        3.41000e02,
        7618.989667648264,
        3.42000e02,
        7618.989667648264,
        3.43000e02,
        7618.989667648264,
        3.44000e02,
        7618.989667648264,
        3.45000e02,
        7618.989667648264,
        3.46000e02,
        7618.989667648264,
        3.47000e02,
        7618.989667648264,
        3.48000e02,
        7618.989667648264,
        3.49000e02,
        7618.989667648264,
        3.50000e02,
        7618.989667648264,
        3.51000e02,
        7618.989667648264,
        3.52000e02,
        7618.989667648264,
        3.53000e02,
        7618.989667648264,
        3.54000e02,
        7618.989667648264,
        3.55000e02,
        7618.989667648264,
        3.56000e02,
        7618.989667648264,
        3.57000e02,
        7618.989667648264,
        3.58000e02,
        7618.989667648264,
        3.59000e02,
        7618.989667648264,
        3.60000e02,
        7618.989667648264,
        3.61000e02,
        7618.989667648264,
        3.62000e02,
        7618.989667648264,
        3.63000e02,
        7618.989667648264,
        3.64000e02,
        7618.989667648264,
        3.65000e02,
        7618.989667648264,
        3.66000e02,
        7618.989667648264,
        3.67000e02,
        7618.989667648264,
        3.68000e02,
        7618.989667648264,
        3.69000e02,
        7618.989667648264,
        3.70000e02,
        7618.989667648264,
        3.71000e02,
        7618.989667648264,
        3.72000e02,
        7618.989667648264,
        3.73000e02,
        7618.989667648264,
        3.74000e02,
        7618.989667648264,
        3.75000e02,
        7618.989667648264,
        3.76000e02,
        7618.989667648264,
        3.77000e02,
        7618.989667648264,
        3.78000e02,
        7618.989667648264,
        3.79000e02,
        7618.989667648264,
        3.80000e02,
        7618.989667648264,
        3.81000e02,
        7618.989667648264,
        3.82000e02,
        7618.989667648264,
        3.83000e02,
        7618.989667648264,
        3.84000e02,
        7618.989667648264,
        3.85000e02,
        7618.989667648264,
        3.86000e02,
        7618.989667648264,
        3.87000e02,
        7618.989667648264,
        3.88000e02,
        7618.989667648264,
        3.89000e02,
        7618.989667648264,
        3.90000e02,
        7618.989667648264,
        3.91000e02,
        7618.989667648264,
        3.92000e02,
        7618.989667648264,
        3.93000e02,
        7618.989667648264,
        3.94000e02,
        7618.989667648264,
        3.95000e02,
        7618.989667648264,
        3.96000e02,
        7618.989667648264,
        3.97000e02,
        7618.989667648264,
        3.98000e02,
        7618.989667648264,
        3.99000e02,
        7618.989667648264,
    ),
    PROL_DROITE="LINEAIRE",
    PROL_GAUCHE="LINEAIRE",
)

MAT_MB3 = DEFI_MATERIAU(ELAS_FO=_F(E=E_MB, NU=NU_MB), RUPT_FM=_F(KIC=K_IC))

MAT_MEC3 = AFFE_MATERIAU(
    MAILLAGE=mamec,
    AFFE=(_F(GROUP_MA="SMB", MATER=MAT_MB3),),
    AFFE_VARC=_F(GROUP_MA=("SMB"), NOM_VARC="TEMP", EVOL=t_proj, VALE_REF=286.0),
)

affe = []
for i in inst:
    champ = CREA_CHAMP(
        TYPE_CHAM="NOEU_DEPL_R",
        OPERATION="AFFE",
        MAILLAGE=mamec,
        AFFE=_F(TOUT="OUI", NOM_CMP=("DX", "DY", "DZ"), VALE=(0, 0, 0)),
    )
    affe.append(
        {"NOM_CHAM": "DEPL", "CHAM_GD": champ, "INST": i, "MODELE": momec, "CHAM_MATER": MAT_MEC3}
    )

rmec_pl = CREA_RESU(OPERATION="AFFE", TYPE_RESU="EVOL_NOLI", AFFE=affe)

# récupération de la table G
# ===

TABLE_G = LIRE_TABLE(UNITE=31)

# appel à POST_FM
# ===

FM = POST_FM(RESULTAT=rmec_pl, TABLE_G=TABLE_G, GROUP_NO="NFISMB")

# tests
# ===

TEST_TABLE(TYPE_TEST="MIN", VALE_CALC=7.05271, NOM_PARA="TEMP", TABLE=FM)

TEST_TABLE(TYPE_TEST="MIN", VALE_CALC=1120.293610931912, NOM_PARA="KIC", TABLE=FM)

TEST_TABLE(
    TYPE_TEST="MAX",
    REFERENCE="AUTRE_ASTER",
    PRECISION=0.002,
    VALE_CALC=2150.7630521585816,
    VALE_REFE=68.11529330737908 * 1000**0.5,
    NOM_PARA="KELAS",
    TABLE=FM,
)

TEST_TABLE(TYPE_TEST="MAX", VALE_CALC=1779.6094007350298, NOM_PARA="KPLAS", TABLE=FM)

TEST_TABLE(
    TYPE_TEST="MAX",
    REFERENCE="AUTRE_ASTER",
    PRECISION=0.02,
    VALE_CALC=1779.6094007350298,
    VALE_REFE=55.23280539241018 * 1000**0.5,
    NOM_PARA="KCP",
    TABLE=FM,
)

TEST_TABLE(TYPE_TEST="MIN", VALE_CALC=0.8529907382901012, NOM_PARA="FM_ASN", TABLE=FM)

TEST_TABLE(
    TYPE_TEST="MIN",
    REFERENCE="AUTRE_ASTER",
    PRECISION=0.02,
    VALE_CALC=1.0635262048534584,
    VALE_REFE=1.08379929189164,
    NOM_PARA="FM_PLAS",
    TABLE=FM,
)

TEST_TABLE(
    FILTRE=_F(NOM_PARA="INST", VALE=900.0),
    TYPE_TEST="MAX",
    VALE_CALC=1.0635262048534584,
    NOM_PARA="FM_PLAS",
    TABLE=FM,
)

# print(FM.EXTR_TABLE())

FIN()
